service: shortlinker-api

frameworkVersion: '3'

provider:
  name: aws
  deploymentMethod: direct
  runtime: nodejs18.x
  region: eu-central-1
  stage: dev

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - 'dynamodb:*'
            - 'ses:*'
            - 'sqs:*'
          Resource: '*'

constructs:
  jobs:
    type: queue
    batchSize: 10
    worker:
      handler: src/lambdas/worker.handler

plugins:
  - serverless-lift
  - serverless-dotenv-plugin
  - serverless-esbuild

package:
  individually: true

functions:
  register:
    handler: src/lambdas/auth.register
    events:
      - http:
          path: /sign-up
          method: post
  login:
    handler: src/lambdas/auth.login
    events:
      - http:
          path: /sign-in
          method: post
    package:
      artifact: .esbuild/.serverless/login.zip
  createLink:
    handler: src/lambdas/links.createLink
    events:
      - http:
          path: /link
          method: post
  getLink:
    handler: src/lambdas/links.getLink
    events:
      - http:
          path: /link/{id}
          method: get
  getLinks:
    handler: src/lambdas/links.getLinks
    events:
      - http:
          path: /links
          method: get
  deleteLink:
    handler: src/lambdas/links.deleteLink
    events:
      - http:
          path: /link/{id}
          method: delete
  publisher:
    handler: src/lambdas/publisher.handler
    events:
      - eventBridge:
          schedule: rate(24 hours)
    environment:
      QUEUE_URL: ${construct:jobs.queueUrl}

resources:
  Resources:
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: UsersTable

        AttributeDefinitions:
          - AttributeName: email
            AttributeType: S

        KeySchema:
          - AttributeName: email
            KeyType: HASH

        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1

    LinksTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: LinksTable

        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S

          - AttributeName: ownerId
            AttributeType: S

        KeySchema:
          - AttributeName: id
            KeyType: HASH

        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1

        GlobalSecondaryIndexes:
          - IndexName: ownerIdGSI
            KeySchema:
              - AttributeName: ownerId
                KeyType: HASH

            Projection:
              ProjectionType: ALL

            ProvisionedThroughput:
              ReadCapacityUnits: 1
              WriteCapacityUnits: 1

custom:
  globalTables:
    regions:
      - eu-central-1
      - eu-west-3
    sources:
      - UsersTable
      - LinksTable

  esbuild:
    bundle: true
    minify: true
    target: 'node18'
    platform: 'node'
    sourcemap: false
