service: shortlinker-api

frameworkVersion: '3'

provider:
  name: aws
  deploymentMethod: direct
  runtime: nodejs18.x
  region: eu-central-1
  stage: dev

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - 'dynamodb:*'
            - 'ses:*'
          Resource: '*'

plugins:
  - serverless-lift
  - serverless-dotenv-plugin
  - serverless-plugin-typescript
  - serverless-esbuild
  - serverless-offline

package:
  individually: true

constructs:
  jobs:
    type: queue
    batchSize: 10
    worker:
      handler: dist/lambdas/worker.handler

functions:
  register:
    handler: dist/lambdas/auth.register
    events:
      - http:
          path: /sign-up
          method: post
  login:
    handler: dist/lambdas/auth.login
    events:
      - http:
          path: /sign-in
          method: post
  createLink:
    handler: dist/lambdas/links.createLink
    events:
      - http:
          path: /link
          method: post
  getLink:
    handler: dist/lambdas/links.getLink
    events:
      - http:
          path: /link/{id}
          method: get
  getLinks:
    handler: dist/lambdas/links.getLinks
    events:
      - http:
          path: /links
          method: get
  deleteLink:
    handler: dist/lambdas/links.deleteLink
    events:
      - http:
          path: /link/{id}
          method: delete

  publisher:
    handler: dist/lambdas/publisher.handler
    events:
      - eventBridge:
          schedule: rate(10 minutes)
    environment:
      QUEUE_URL: ${construct:jobs.queueUrl}

  # processExpiredLinks:
  #   handler: src/lambdas/processExpiredLinks.handler
  #   events:
  #     - eventBridge:
  #         schedule: rate(1 hour)

  #     - sqs:
  #         batchSize: 10
  #         functionResponseType: ReportBatchItemFailures

  #   environment:
  #     SQS_QUEUE_URL:
  #       Fn::ImportValue: ExpiredLinksSQSQueueUrl

resources:
  Resources:
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: UsersTable

        AttributeDefinitions:
          - AttributeName: email
            AttributeType: S

        KeySchema:
          - AttributeName: email
            KeyType: HASH

        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1

    LinksTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: LinksTable

        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S

          - AttributeName: ownerId
            AttributeType: S

        KeySchema:
          - AttributeName: id
            KeyType: HASH

        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1

        GlobalSecondaryIndexes:
          - IndexName: ownerIdGSI
            KeySchema:
              - AttributeName: ownerId
                KeyType: HASH

            Projection:
              ProjectionType: ALL

            ProvisionedThroughput:
              ReadCapacityUnits: 1
              WriteCapacityUnits: 1

    # ExpiredLinksSQSQueue:
    #   Type: 'AWS::SQS::Queue'
    #   Properties:
    #     QueueName: 'ExpiredLinksSQSQueue'

    # ExpiredLinksSQSQueuePolicy:
    #   Type: AWS::SQS::QueuePolicy
    #   Properties:
    #     Queues:
    #       - Ref: ExpiredLinksSQSQueue
    #     PolicyDocument:
    #       Version: '2012-10-17'
    #       Statement:
    #         - Effect: Allow
    #           Principal: '*'
    #           Action: 'sqs:SendMessage'
    #           Resource:
    #             Fn::GetAtt:
    #               - ExpiredLinksSQSQueue
    #               - Arn

custom:
  globalTables:
    regions:
      - eu-central-1
      - eu-west-3
    sources:
      - UsersTable
      - LinksTable

  esbuild:
    tsconfig: true
  #   entryPoints:
  #     - './src/**/*.ts'
  #   bundle: true
  #   minify: true
  #   platform: 'node'
  #   sourcemap: true
  #   target: 'node18'
# Outputs:
#   ExpiredLinksSQSQueueUrl:
#     Value:
#       Fn::GetAtt:
#         - ExpiredLinksSQSQueue
#         - Arn
#     Export:
#       Name: ExpiredLinksSQSQueueUrl
